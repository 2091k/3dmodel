<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3DæŒ‰é”®è§£å‹ Â· èµŒç¥</title>
    <style>

        body {
            margin: 0;
            padding: 0;
            background: radial-gradient(circle at 50% 50%, #0d0b1a 0%, #0a0718 100%);
            font-family: 'Noto Sans SC', 'Microsoft YaHei', sans-serif;
            overflow: hidden;
            transition: background 0.5s ease;
            position: relative;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image: 
                linear-gradient(rgba(255, 215, 0, 0.08) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 215, 0, 0.08) 1px, transparent 1px);
            background-size: 32px 32px;
            pointer-events: none;
            z-index: -1;
        }
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at 30% 40%, rgba(255,200,50,0.02) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        #container { width: 100vw; height: 100vh; position: relative; }
        #info {
            position: absolute; 
            top: 20px; 
            left: 20px; 
            color: #ffddaa; 
            font-size: 14px;
            background: rgba(10, 5, 0, 0.75); 
            padding: 10px 18px; 
            border-radius: 30px;
            z-index: 100;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,215,0,0.3);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            letter-spacing: 1px;
            font-weight: 400;
        }
        #loading {
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            color: #ffcc88; 
            font-size: 20px; 
            z-index: 200;
            text-shadow: 0 0 15px #ffaa00;
            background: rgba(0,0,0,0.6);
            padding: 12px 28px;
            border-radius: 40px;
            border: 1px solid #ffcc66;
            backdrop-filter: blur(4px);
        }
        #config-panel {
            position: absolute;
            top: 70px;
            left: 20px;
            background: rgba(8, 6, 12, 0.96);
            color: #ffebc2;
            padding: 20px;
            border-radius: 16px;
            z-index: 1000;
            font-size: 12px;
            width: 290px;
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 204, 0, 0.4);
            box-shadow: 0 10px 30px rgba(0,0,0,0.7), 0 0 0 1px rgba(255,215,0,0.1) inset;
            display: none;
            max-height: 80vh;
            overflow-y: auto;
            letter-spacing: 0.5px;
        }
        #config-panel h3 {
            margin: 0 0 16px 0;
            font-size: 16px;
            color: #ffd966;
            text-align: left;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,204,0,0.3);
            text-shadow: 0 0 6px rgba(255,200,0,0.5);
            display: flex;
            align-items: center;
        }
        .config-group { margin-bottom: 16px; }
        .config-group label { 
            display: block; 
            margin-bottom: 6px; 
            color: #f0e6c5; 
            font-weight: 400;
            font-size: 12px;
        }
        .config-group input[type="range"] {
            width: 100%;
            -webkit-appearance: none;
            height: 6px;
            background: rgba(255,215,0,0.15);
            border-radius: 3px;
            outline: none;
            border: 1px solid rgba(255,200,0,0.2);
        }
        .config-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: radial-gradient(circle, #ffd966, #cc9900);
            cursor: pointer;
            box-shadow: 0 0 10px #ffcc00, 0 0 2px 1px #000;
            border: 1px solid rgba(255,255,200,0.8);
        }
        .value-display {
            display: inline-block;
            margin-left: 8px;
            font-weight: 600;
            color: #ffcc66;
            min-width: 40px;
            text-align: right;
            float: right;
            background: rgba(0,0,0,0.3);
            padding: 0 6px;
            border-radius: 10px;
        }
        .color-preview {
            display: inline-block;
            width: 18px;
            height: 18px;
            border-radius: 4px;
            margin-left: 8px;
            vertical-align: middle;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 0 6px rgba(255,204,0,0.3);
        }
        #toggle-config {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(145deg, #1e1a1a, #0c0a0a);
            color: #ffd966;
            border: 1px solid #b38f40;
            padding: 10px 22px;
            border-radius: 40px;
            cursor: pointer;
            z-index: 100;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 6px 16px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,215,0,0.2);
            backdrop-filter: blur(4px);
            letter-spacing: 2px;
            font-size: 14px;
        }
        #toggle-config:hover {
            background: #2a1f1a;
            transform: translateY(-2px);
            box-shadow: 0 12px 20px rgba(0,0,0,0.7), 0 0 0 1px #ffcc66;
            color: #ffefb0;
        }
        .config-section {
            margin-bottom: 18px;
            padding: 14px;
            background: rgba(20, 15, 10, 0.6);
            border-radius: 12px;
            border-left: 4px solid #ffcc66;
            box-shadow: 0 2px 8px rgba(0,0,0,0.6);
        }
        .config-section h4 {
            margin: 0 0 12px 0;
            font-size: 13px;
            color: #ffdb8e;
            display: flex;
            align-items: center;
            font-weight: 600;
        }
        .config-section h4::before {
            content: "â—†";
            margin-right: 6px;
            color: #ffcc88;
            font-size: 11px;
        }
        #colorPresets {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 12px;
        }
        .color-preset-btn {
            padding: 8px 2px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 10px;
            color: #fff;
            transition: all 0.2s ease;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,204,0,0.3);
            font-weight: 500;
            text-shadow: 0 1px 2px black;
        }
        .color-preset-btn:hover {
            transform: scale(1.05);
            border-color: #ffcc66;
            box-shadow: 0 0 12px #ffcc00;
        }
        .button-group { display: flex; gap: 15px; margin-top: 20px; }
        .config-button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 13px;
            letter-spacing: 2px;
        }
        #applyChanges {
            background: linear-gradient(145deg, #e6b800, #cc9900);
            color: #000;
            border: 1px solid #ffdd55;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        }
        #resetDefaults {
            background: rgba(30,25,20,0.9);
            color: #ffd966;
            border: 1px solid #a68a3c;
        }
        .config-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.6);
        }
        #closePanel {
            position: absolute;
            top: 8px;
            right: 12px;
            background: none;
            border: none;
            color: #ffcc88;
            font-size: 24px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        #closePanel:hover { background: rgba(255,204,0,0.2); color: #fff; }
        .color-input-container { margin-top: 8px; }
        .color-input-container input[type="color"] {
            width: 100%;
            height: 34px;
            border: 1px solid #665511;
            border-radius: 8px;
            cursor: pointer;
            background: #1a120a;
        }
        #config-panel::-webkit-scrollbar { width: 6px; }
        #config-panel::-webkit-scrollbar-track { background: #0a0704; border-radius: 3px; }
        #config-panel::-webkit-scrollbar-thumb { background: #b38f40; border-radius: 3px; border: 1px solid #e6c300; }
        #config-panel::-webkit-scrollbar-thumb:hover { background: #ffcc66; }
    </style>
    <!-- é…ç½® Import Map ä»¥ç®€åŒ–æ¨¡å—å¯¼å…¥ -->
<script type="importmap">
    {
        "imports": {
            "three": "http://3dmodel.2091k.cn/button/js/three.module.js",
            "three/addons/": "http://3dmodel.2091k.cn/button/js/"
        }
    }
</script>
</head>
<body>
    <div id="container">
        <div id="loading">3Dæ¨¡å‹åŠ è½½ä¸­</div>
 <!--       <div id="info">ğŸ° ç‚¹å‡»æŒ‰é”® Â· éœ¸æ°”å‘å£° | æ‹–åŠ¨æ—‹è½¬è§†è§’ | æ»šè½®ç¼©æ”¾ç»†èŠ‚</div>  -->
        <button id="toggle-config">âš™ï¸</button>
        <div id="config-panel">
            <button id="closePanel">Ã—</button>
            <h3>ğŸƒ 3DæŒ‰é”® Â· å°Šäº«è°ƒå‚</h3>
            
            <div class="config-section">
                <h4>åœ†è§’ä¸æ¯”ä¾‹</h4>
                <div class="config-group">
                    <label>ğŸ›ï¸ æŒ‰é”®åœ†è§’: <span id="keyRadiusValue" class="value-display">0.15</span></label>
                    <input type="range" id="keyRadiusSlider" min="0.05" max="0.3" step="0.01" value="0.15">
                </div>
                <div class="config-group">
                    <label>ğŸ›ï¸ åŸºåº§åœ†è§’: <span id="baseRadiusValue" class="value-display">0.1</span></label>
                    <input type="range" id="baseRadiusSlider" min="0.05" max="0.2" step="0.01" value="0.1">
                </div>
                <div class="config-group">
                    <label>âš™ï¸ å‡¹æ§½åœ†è§’: <span id="grooveRadiusValue" class="value-display">0.03</span></label>
                    <input type="range" id="grooveRadiusSlider" min="0.01" max="0.08" step="0.01" value="0.03">
                </div>
                <div class="config-group">
                    <label>ğŸ”¤ æ–‡å­—æ¯”ä¾‹: <span id="textSizeValue" class="value-display">1.0</span></label>
                    <input type="range" id="textSizeSlider" min="0.8" max="1.2" step="0.05" value="1.0">
                </div>
            </div>
            
            <div class="config-section">
                <h4>æ¨¡æ¿é‡‘å±è‰²</h4>
                <div class="config-group">
                    <label>ğŸ¥‡ åŸºåº§é¢œè‰²: 
                        <span id="baseColorValue" class="value-display">#a88f12</span>
                        <div id="baseColorPreview" class="color-preview" style="background-color: #a88f12;"></div>
                    </label>
                    <div class="color-input-container">
                        <input type="color" id="baseColorPicker" value="#a88f12">
                    </div>
                </div>
                <div class="config-group">
                    <label>ğŸ¥ˆ å‡¹æ§½é¢œè‰²: 
                        <span id="grooveColorValue" class="value-display">#8a7310</span>
                        <div id="grooveColorPreview" class="color-preview" style="background-color: #8a7310;"></div>
                    </label>
                    <div class="color-input-container">
                        <input type="color" id="grooveColorPicker" value="#8a7310">
                    </div>
                </div>
            </div>
            
            <div class="config-section">
                <h4>æŒ‰é’®é‡‰è‰²</h4>
                <div class="config-group">
                    <label>ğŸŒŸ é»„é‡‘æŒ‰é”®: 
                        <span id="keyYellowValue" class="value-display">#b99c15</span>
                        <div id="keyYellowPreview" class="color-preview" style="background-color: #b99c15;"></div>
                    </label>
                    <div class="color-input-container">
                        <input type="color" id="keyYellowPicker" value="#b99c15">
                    </div>
                </div>
                <div class="config-group">
                    <label>ğŸ’ é“‚é‡‘æŒ‰é”®: 
                        <span id="keyWhiteValue" class="value-display">#f0f0f0</span>
                        <div id="keyWhitePreview" class="color-preview" style="background-color: #f0f0f0;"></div>
                    </label>
                    <div class="color-input-container">
                        <input type="color" id="keyWhitePicker" value="#f0f0f0">
                    </div>
                </div>
            </div>

            <!-- ========== ğŸ†• æ–°å¢ï¼šæ–‡å­—æ ·å¼ç‹¬ç«‹è°ƒèŠ‚åŒº ========== -->
            <div class="config-section">
                <h4>ğŸ“ æ–‡å­—æ ·å¼</h4>
                <div class="config-group">
                    <label>ğŸŸ¡ é»„é‡‘æŒ‰é”®æ–‡å­—è‰²: 
                        <span id="textColorYellowValue" class="value-display">#1a0f00</span>
                        <div id="textColorYellowPreview" class="color-preview" style="background-color: #1a0f00;"></div>
                    </label>
                    <div class="color-input-container">
                        <input type="color" id="textColorYellowPicker" value="#1a0f00">
                    </div>
                </div>
                <div class="config-group">
                    <label>âšª é“‚é‡‘æŒ‰é”®æ–‡å­—è‰²: 
                        <span id="textColorWhiteValue" class="value-display">#0a0a0a</span>
                        <div id="textColorWhitePreview" class="color-preview" style="background-color: #0a0a0a;"></div>
                    </label>
                    <div class="color-input-container">
                        <input type="color" id="textColorWhitePicker" value="#0a0a0a">
                    </div>
                </div>
                <div class="config-group">
                    <label>ğŸ”¤ æ‹¼éŸ³æ–‡å­—è‰²: 
                        <span id="textPinyinColorValue" class="value-display">#fff5e6</span>
                        <div id="textPinyinColorPreview" class="color-preview" style="background-color: #fff5e6;"></div>
                    </label>
                    <div class="color-input-container">
                        <input type="color" id="textPinyinColorPicker" value="#fff5e6">
                    </div>
                </div>
            </div>
            
            <div class="config-section">
                <h4>æš—å½±ç§˜æŠ€</h4>
                <div class="config-group">
                    <label>ğŸŒ‘ æŠ•å½±å¼ºåº¦: <span id="shadowIntensityValue" class="value-display">0.6</span></label>
                    <input type="range" id="shadowIntensitySlider" min="0.1" max="1.0" step="0.1" value="0.6">
                </div>
                <div class="config-group">
                    <label>ğŸŒ«ï¸ æŠ•å½±æŸ”åŒ–: <span id="shadowSoftnessValue" class="value-display">0.5</span></label>
                    <input type="range" id="shadowSoftnessSlider" min="0.1" max="1.0" step="0.1" value="0.5">
                </div>
                <div class="config-group">
                    <label>ğŸ–¤ æŠ•å½±è‰²: 
                        <span id="shadowColorValue" class="value-display">#000</span>
                        <div id="shadowColorPreview" class="color-preview" style="background-color: #000000;"></div>
                    </label>
                    <div class="color-input-container">
                        <input type="color" id="shadowColorPicker" value="#000000">
                    </div>
                </div>
            </div>
            
            <div class="config-section">
                <h4>å…‰Â·å½±è‰ºæœ¯</h4>
                <div class="config-group">
                    <label>â˜€ï¸ å…¨å±€äº®åº¦: <span id="globalBrightnessValue" class="value-display">1.0</span></label>
                    <input type="range" id="globalBrightnessSlider" min="0.1" max="2.0" step="0.1" value="1.0">
                </div>
                <div class="config-group">
                    <label>ğŸ’¡ ç¯å¢ƒå…‰: <span id="ambientLightValue" class="value-display">0.8</span></label>
                    <input type="range" id="ambientLightSlider" min="0.1" max="2.0" step="0.1" value="0.8">
                </div>
                <div class="config-group">
                    <label>ğŸ”† ä¸»å…‰æº: <span id="mainLightValue" class="value-display">1.1</span></label>
                    <input type="range" id="mainLightSlider" min="0.1" max="2.0" step="0.1" value="1.1">
                </div>
                <div class="config-group">
                    <label>âœ¨ è¡¥å…‰: <span id="fillLightValue" class="value-display">0.4</span></label>
                    <input type="range" id="fillLightSlider" min="0.1" max="2.0" step="0.1" value="0.4">
                </div>
                <div class="config-group">
                    <label>ğŸŒ‡ è½®å»“å…‰: <span id="backLightValue" class="value-display">0.3</span></label>
                    <input type="range" id="backLightSlider" min="0.1" max="2.0" step="0.1" value="0.3">
                </div>
            </div>
            
            <div class="config-section">
                <h4>èµŒç¥æ°›å›´</h4>
                <div class="config-group">
                    <label>ğŸ† ä¸»èƒŒæ™¯è‰²: 
                        <span id="bgColor1Value" class="value-display">#1a1a2e</span>
                        <div id="bgColor1Preview" class="color-preview" style="background-color: #1a1a2e;"></div>
                    </label>
                    <div class="color-input-container">
                        <input type="color" id="bgColor1Picker" value="#1a1a2e">
                    </div>
                </div>
                <div class="config-group">
                    <label>ğŸŒŒ è¾…èƒŒæ™¯è‰²: 
                        <span id="bgColor2Value" class="value-display">#16213e</span>
                        <div id="bgColor2Preview" class="color-preview" style="background-color: #16213e;"></div>
                    </label>
                    <div class="color-input-container">
                        <input type="color" id="bgColor2Picker" value="#16213e">
                    </div>
                </div>
                <label style="margin-bottom: 6px; display: block; color:#ffdb8e;">ğŸ¨ ç»å…¸åœºæ™¯é¢„è®¾:</label>
                <div id="colorPresets">
                    <button class="color-preset-btn" data-bg1="#0a0818" data-bg2="#130e28" style="background: linear-gradient(135deg, #0a0818, #130e28);">å¸ç‹é‡‘</button>
                    <button class="color-preset-btn" data-bg1="#1e1a2b" data-bg2="#2c1e3a" style="background: linear-gradient(135deg, #1e1a2b, #2c1e3a);">ç´«é‡‘</button>
                    <button class="color-preset-btn" data-bg1="#0c0b0b" data-bg2="#1f1b14" style="background: linear-gradient(135deg, #0c0b0b, #1f1b14);">é›ªèŒ„</button>
                    <button class="color-preset-btn" data-bg1="#1f2a3a" data-bg2="#0f1a2f" style="background: linear-gradient(135deg, #1f2a3a, #0f1a2f);">æ·±æµ·èµŒå±€</button>
                    <button class="color-preset-btn" data-bg1="#2c1e1e" data-bg2="#3e2a2a" style="background: linear-gradient(135deg, #2c1e1e, #3e2a2a);">çº¢é…’</button>
                    <button class="color-preset-btn" data-bg1="#1a1a1a" data-bg2="#2a2a1a" style="background: linear-gradient(135deg, #1a1a1a, #2a2a1a);">æ©„æ¦„ç»¿</button>
                </div>
            </div>
            <div class="button-group">
                <button id="applyChanges" class="config-button">ç«‹å³ç”Ÿæ•ˆ</button>
                <button id="resetDefaults" class="config-button">é‡ç½®è‡³å®</button>
            </div>
        </div>
    </div>

    <script type="module">
        // ---------- â™ ï¸ é‡‡ç”¨ ES Module æ–¹å¼ï¼Œç¡®ä¿æ‰€æœ‰ Three.js ç»„ä»¶æ­£ç¡®åŠ è½½ â™¥ï¸ ----------
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { RoundedBoxGeometry } from 'three/addons/geometries/RoundedBoxGeometry.js';

        // ---------- éŸ³æ•ˆåº“ ----------
        const sounds = {
            'æˆ‘è¦éªŒç‰Œ': 'http://3dmodel.2091k.cn/button/audio/wyyp.mp3',
            'ç‰Œæ²¡é—®é¢˜': 'http://3dmodel.2091k.cn/button/audio/pmywt.mp3',
            'å°ç˜ªä¸‰': 'http://3dmodel.2091k.cn/button/audio/xbs.mp3',
            'ç»™æˆ‘æ“¦çš®é‹': 'http://3dmodel.2091k.cn/button/audio/gwcpx.mp3'
        };

        const keyTexts = {
            'æˆ‘è¦éªŒç‰Œ': { cn: 'æˆ‘è¦éªŒç‰Œ', pinyin: 'wÇ’ yÃ o yÃ n pÃ¡i' },
            'ç‰Œæ²¡é—®é¢˜': { cn: 'ç‰Œæ²¡é—®é¢˜', pinyin: 'pÃ¡i mÃ©i yÇ’u wÃ¨n tÃ­' },
            'å°ç˜ªä¸‰': { cn: 'å°ç˜ªä¸‰', pinyin: 'xiÇo biÄ“ sÄn' },
            'ç»™æˆ‘æ“¦çš®é‹': { cn: 'ç»™æˆ‘æ“¦çš®é‹', pinyin: 'gÄ›i wÇ’ cÄ pÃ­ xiÃ©' }
        };

        const COLOR_CONFIG = {
            BASE_COLOR: 0xa88f12,
            GROOVE_COLOR: 0x8a7310,
            KEY_YELLOW: 0xb99c15,
            KEY_WHITE: 0xf0f0f0
        };

        const KEY_CONFIGS = [
            { soundKey: 'æˆ‘è¦éªŒç‰Œ', color: COLOR_CONFIG.KEY_YELLOW, pos: { x: -0.6, y: 0, z: -0.6 } },
            { soundKey: 'ç‰Œæ²¡é—®é¢˜', color: COLOR_CONFIG.KEY_WHITE, pos: { x: 0.6, y: 0, z: -0.6 } },
            { soundKey: 'å°ç˜ªä¸‰', color: COLOR_CONFIG.KEY_WHITE, pos: { x: -0.6, y: 0, z: 0.6 } },
            { soundKey: 'ç»™æˆ‘æ“¦çš®é‹', color: COLOR_CONFIG.KEY_YELLOW, pos: { x: 0.6, y: 0, z: 0.6 } }
        ];

        const CAMERA_CONFIG = {
            POSITION: { x: 0, y: 6, z: 3 },
            MIN_DISTANCE: 3,
            MAX_DISTANCE: 8,
            MAX_POLAR_ANGLE: Math.PI / 2.2
        };

        // ---------- å¯è°ƒèŠ‚å‚æ•° ----------
        let ROUNDED_CONFIG = {
            keyRadius: 0.15,
            baseRadius: 0.1,
            grooveRadius: 0.03,
            textSize: 1.0
        };

        let SHADOW_CONFIG = {
            intensity: 0.65,
            softness: 0.6,
            color: "#1a0f0a"
        };
//é»˜è®¤èƒŒæ™¯è‰²
        let BACKGROUND_CONFIG = {
            color1: "#1e1a2b",
            color2: "#0a0718"
        };

        let TEMPLATE_COLOR_CONFIG = {
            baseColor: "#551616",
            grooveColor: "#8a7310"
        };

        let BUTTON_COLOR_CONFIG = {
            keyYellow: "#b99c15",
            keyWhite: "#f0f0f0",
            // ğŸ†• æ–°å¢æ–‡å­—é¢œè‰²é…ç½®
            textColorOnYellow: "#000000",   // é»„é‡‘æŒ‰é”®ä¸Šçš„ä¸­æ–‡è‰²
            textColorOnWhite: "#000000",   // é“‚é‡‘æŒ‰é”®ä¸Šçš„ä¸­æ–‡è‰²
            textPinyinColor: "#000000"     // æ‹¼éŸ³æ–‡å­—è‰²
        };

        let LIGHT_CONFIG = {
            globalBrightness: 1.0,
            mainLightIntensity: 1.2,
            ambientLightIntensity: 0.85,
            fillLightIntensity: 0.5,
            backLightIntensity: 0.4
        };
//é‡ç½®å‚æ•°è‰²å€¼
        const DEFAULT_CONFIG = {
            ROUNDED_CONFIG: { keyRadius: 0.15, baseRadius: 0.1, grooveRadius: 0.03, textSize: 1.0 },
            SHADOW_CONFIG: { intensity: 0.65, softness: 0.6, color: "#1a0f0a" },
            BACKGROUND_CONFIG: { color1: "#1e1a2b", color2: "#0a0718" },
            TEMPLATE_COLOR_CONFIG: { baseColor: "#a88f12", grooveColor: "#8a7310" },
            BUTTON_COLOR_CONFIG: { 
                keyYellow: "#b99c15", 
                keyWhite: "#f0f0f0",
                textColorOnYellow: "#1a0f00",
                textColorOnWhite: "#0a0a0a",
                textPinyinColor: "#fff5e6"
            },
            LIGHT_CONFIG: { globalBrightness: 1.0, mainLightIntensity: 1.2, ambientLightIntensity: 0.85, fillLightIntensity: 0.5, backLightIntensity: 0.4 }
        };

        let scene, camera, renderer, controls;
        let keys = [], base = null, grooves = [], keyShadows = [];
        let ambientLight, mainDirectionalLight, fillLight, backLight;
        let updateTimeout = null;
        let particles;

        // ---------- åˆå§‹åŒ–åœºæ™¯ ----------
        function init() {
            document.getElementById('loading').style.display = 'none';
            scene = new THREE.Scene();
            scene.background = null;

            camera = new THREE.PerspectiveCamera(50, innerWidth / innerHeight, 0.1, 1000);
            camera.position.set(CAMERA_CONFIG.POSITION.x, CAMERA_CONFIG.POSITION.y, CAMERA_CONFIG.POSITION.z);
            camera.lookAt(0, 0.2, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(innerWidth, innerHeight);
            renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.toneMapping = THREE.ReinhardToneMapping;
            renderer.toneMappingExposure = 1.2;
            document.getElementById('container').appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.07;
            controls.rotateSpeed = 0.8;
            controls.zoomSpeed = 1.2;
            controls.maxPolarAngle = CAMERA_CONFIG.MAX_POLAR_ANGLE;
            controls.minDistance = CAMERA_CONFIG.MIN_DISTANCE;
            controls.maxDistance = CAMERA_CONFIG.MAX_DISTANCE;
            controls.enablePan = true;
            controls.target.set(0, 0.2, 0);

            // ç¯å…‰ç³»ç»Ÿ
            ambientLight = new THREE.AmbientLight(0xffeedd, LIGHT_CONFIG.ambientLightIntensity * LIGHT_CONFIG.globalBrightness);
            scene.add(ambientLight);

            mainDirectionalLight = new THREE.DirectionalLight(0xffeebb, LIGHT_CONFIG.mainLightIntensity * LIGHT_CONFIG.globalBrightness);
            mainDirectionalLight.position.set(2.5, 5, 4);
            mainDirectionalLight.castShadow = true;
            mainDirectionalLight.receiveShadow = true;
            mainDirectionalLight.shadow.mapSize.width = 2048;
            mainDirectionalLight.shadow.mapSize.height = 2048;
            mainDirectionalLight.shadow.camera.near = 0.5;
            mainDirectionalLight.shadow.camera.far = 30;
            mainDirectionalLight.shadow.camera.left = -6;
            mainDirectionalLight.shadow.camera.right = 6;
            mainDirectionalLight.shadow.camera.top = 6;
            mainDirectionalLight.shadow.camera.bottom = -6;
            mainDirectionalLight.shadow.radius = SHADOW_CONFIG.softness * 3;
            mainDirectionalLight.shadow.bias = -0.0005;
            scene.add(mainDirectionalLight);

            fillLight = new THREE.DirectionalLight(0xcceeff, LIGHT_CONFIG.fillLightIntensity * LIGHT_CONFIG.globalBrightness);
            fillLight.position.set(-3, 2, 3);
            fillLight.castShadow = false;
            scene.add(fillLight);

            backLight = new THREE.DirectionalLight(0xffaa66, LIGHT_CONFIG.backLightIntensity * LIGHT_CONFIG.globalBrightness);
            backLight.position.set(-1, 1, -6);
            backLight.castShadow = false;
            scene.add(backLight);

            const rimLight = new THREE.PointLight(0xffaa33, 0.5);
            rimLight.position.set(1, 2, -3);
            scene.add(rimLight);

            createAtmosphereParticles();
            createBase();
            createKeys();
            updateBackground();
            setupConfigPanel();
            bindEvents();
            updateLightIntensity();
        }

        // ---------- ç²’å­ç‰¹æ•ˆ ----------
        function createAtmosphereParticles() {
            const particleCount = 280;
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(particleCount * 3);
            const colors = new Float32Array(particleCount * 3);
            const color = new THREE.Color();

            for (let i = 0; i < particleCount; i++) {
                positions[i * 3] = (Math.random() - 0.5) * 40;
                positions[i * 3 + 1] = (Math.random() - 0.5) * 20;
                positions[i * 3 + 2] = (Math.random() - 0.8) * 40 - 10;
                
                const hue = 0.12 + Math.random() * 0.15;
                color.setHSL(hue, 0.7, 0.5);
                colors[i * 3] = color.r;
                colors[i * 3 + 1] = color.g;
                colors[i * 3 + 2] = color.b;
            }
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

            const material = new THREE.PointsMaterial({
                size: 0.18,
                vertexColors: true,
                transparent: true,
                opacity: 0.45,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });
            particles = new THREE.Points(geometry, material);
            scene.add(particles);
        }

        // ---------- èƒŒæ™¯æ›´æ–° ----------
        function updateBackground() {
            document.body.style.background = `radial-gradient(circle at 50% 50%, ${BACKGROUND_CONFIG.color1} 0%, ${BACKGROUND_CONFIG.color2} 100%)`;
        }

        // ---------- æ¨¡æ¿é¢œè‰²æ›´æ–° ----------
        function updateTemplateColors() {
            if (base) base.material.color.set(TEMPLATE_COLOR_CONFIG.baseColor);
            grooves.forEach(g => g.material.color.set(TEMPLATE_COLOR_CONFIG.grooveColor));
        }

        // ---------- æŒ‰é’®é¢œè‰²æ›´æ–° ----------
        function updateButtonColors() {
            keys.forEach((k, i) => {
                const isYellow = KEY_CONFIGS[i].color === COLOR_CONFIG.KEY_YELLOW;
                const col = isYellow ? BUTTON_COLOR_CONFIG.keyYellow : BUTTON_COLOR_CONFIG.keyWhite;
                k.material.color.set(col);
            });
        }

        // ---------- å…‰ç…§å¼ºåº¦æ›´æ–° ----------
        function updateLightIntensity() {
            ambientLight.intensity = LIGHT_CONFIG.ambientLightIntensity * LIGHT_CONFIG.globalBrightness;
            mainDirectionalLight.intensity = LIGHT_CONFIG.mainLightIntensity * LIGHT_CONFIG.globalBrightness;
            fillLight.intensity = LIGHT_CONFIG.fillLightIntensity * LIGHT_CONFIG.globalBrightness;
            backLight.intensity = LIGHT_CONFIG.backLightIntensity * LIGHT_CONFIG.globalBrightness;
        }

        // ---------- åˆ›å»ºåŸºåº§ ----------
        function createBase() {
            if (base) scene.remove(base);
            const geometry = new RoundedBoxGeometry(2.5, 1.1, 2.5, 8, ROUNDED_CONFIG.baseRadius);
            const material = new THREE.MeshStandardMaterial({
                color: TEMPLATE_COLOR_CONFIG.baseColor,
                roughness: 0.28,
                metalness: 0.22,
                emissive: new THREE.Color(0x332200),
                emissiveIntensity: 0.04,
                side: THREE.DoubleSide
            });
            base = new THREE.Mesh(geometry, material);
            base.position.y = -0.55;
            base.castShadow = true;
            base.receiveShadow = true;
            scene.add(base);
            createGrooves(base);
        }

        // ---------- åˆ›å»ºå‡¹æ§½ ----------
        function createGrooves(parent) {
            grooves.forEach(g => { if (g.parent) g.parent.remove(g); });
            grooves = [];
            const positions = [
                { x: -0.6, y: 0.48, z: -0.6 },
                { x: 0.6, y: 0.48, z: -0.6 },
                { x: -0.6, y: 0.48, z: 0.6 },
                { x: 0.6, y: 0.48, z: 0.6 }
            ];
            positions.forEach(pos => {
                const geo = new RoundedBoxGeometry(1.08, 0.08, 1.08, 6, ROUNDED_CONFIG.grooveRadius);
                const mat = new THREE.MeshStandardMaterial({
                    color: TEMPLATE_COLOR_CONFIG.grooveColor,
                    roughness: 0.45,
                    metalness: 0.35,
                    emissive: new THREE.Color(0x221100),
                    emissiveIntensity: 0.02
                });
                const groove = new THREE.Mesh(geo, mat);
                groove.position.set(pos.x, pos.y, pos.z);
                groove.castShadow = true;
                groove.receiveShadow = true;
                parent.add(groove);
                grooves.push(groove);
            });
        }

        // ---------- åˆ›å»ºæŒ‰é”®ï¼ˆå¸¦æ–‡å­—ï¼‰----------
        function createKeys() {
            keys.forEach(k => scene.remove(k));
            keyShadows.forEach(s => scene.remove(s));
            keys = [];
            keyShadows = [];

            KEY_CONFIGS.forEach((cfg, idx) => {
                const shadowColor = new THREE.Color(SHADOW_CONFIG.color);
                const shadowGeo = new RoundedBoxGeometry(1.08, 0.04, 1.08, 6, ROUNDED_CONFIG.keyRadius * 0.9);
                const shadowMat = new THREE.MeshStandardMaterial({
                    color: shadowColor,
                    transparent: true,
                    opacity: SHADOW_CONFIG.intensity * 0.8,
                    roughness: 0.8,
                    metalness: 0.1,
                    emissive: new THREE.Color(0x111111),
                    emissiveIntensity: 0.1
                });
                const shadow = new THREE.Mesh(shadowGeo, shadowMat);
                shadow.position.set(cfg.pos.x, cfg.pos.y - 0.22, cfg.pos.z);
                shadow.userData = { originalY: cfg.pos.y - 0.22, keyIndex: idx };
                scene.add(shadow);
                keyShadows.push(shadow);

                const keyColor = cfg.color === COLOR_CONFIG.KEY_YELLOW ? BUTTON_COLOR_CONFIG.keyYellow : BUTTON_COLOR_CONFIG.keyWhite;
                // æŒ‰é’®é«˜åº¦å·²æŒ‰æ‚¨çš„è¦æ±‚è°ƒæ•´ä¸º 0.5
                const keyGeo = new RoundedBoxGeometry(1, 0.5, 1, 10, ROUNDED_CONFIG.keyRadius);
                const keyMat = new THREE.MeshStandardMaterial({
                    color: keyColor,
                    roughness: 0.24,
                    metalness: 0.18,
                    emissive: cfg.color === COLOR_CONFIG.KEY_YELLOW ? new THREE.Color(0x553300) : new THREE.Color(0x222222),
                    emissiveIntensity: 0.03,
                    side: THREE.DoubleSide
                });
                const key = new THREE.Mesh(keyGeo, keyMat);
                key.position.set(cfg.pos.x, cfg.pos.y, cfg.pos.z);
                key.userData = {
                    sound: cfg.soundKey,
                    originalY: cfg.pos.y,
                    isPressed: false,
                    shadowIndex: keyShadows.length - 1
                };
                key.castShadow = true;
                key.receiveShadow = true;

                // è°ƒç”¨æ–‡å­—ç”Ÿæˆå‡½æ•°ï¼Œä¼ å…¥é…ç½®é¢œè‰²
                createLuxuryText(key, cfg.soundKey, cfg.color);
                scene.add(key);
                keys.push(key);
            });
        }

        // ---------- âœ¨ å¥¢åæ–‡å­—ç»˜åˆ¶ï¼ˆæ”¯æŒåŠ¨æ€è°ƒè‰²ï¼‰----------
        function createLuxuryText(key, soundKey, colorHex) {
            key.children.forEach(c => { if (c.isMesh && c.material.map) key.remove(c); });

            const canvas = document.createElement('canvas');
            canvas.width = 2048;
            canvas.height = 2048;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const isYellowKey = (colorHex === COLOR_CONFIG.KEY_YELLOW);
            
            ctx.font = 'bold 360px "Noto Sans SC", "Microsoft YaHei", sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            ctx.shadowColor = 'rgba(0,0,0,0.8)';
            ctx.shadowBlur = 20;
            ctx.shadowOffsetX = 6;
            ctx.shadowOffsetY = 6;
            
            // ç™½è‰²æè¾¹ï¼ˆå›ºå®šä¸ºé«˜è´µç™½ï¼‰
            ctx.lineWidth = 24;
            ctx.strokeStyle = '#ffffff';
            ctx.strokeText(keyTexts[soundKey].cn, 1024, 880);
            
            // ===== ä¸­æ–‡ä¸»è‰² ===== ä»é…ç½®è¯»å– =====
            ctx.fillStyle = isYellowKey ? BUTTON_COLOR_CONFIG.textColorOnYellow : BUTTON_COLOR_CONFIG.textColorOnWhite;
            ctx.shadowBlur = 28;
            ctx.shadowColor = 'rgba(255,215,0,0.7)';
            ctx.fillText(keyTexts[soundKey].cn, 1024, 880);

            // æ‹¼éŸ³éƒ¨åˆ†
            ctx.font = 'bold 190px "Noto Sans SC", "Microsoft YaHei", sans-serif';
            ctx.shadowBlur = 16;
            ctx.shadowOffsetX = 4;
            ctx.shadowOffsetY = 4;
            ctx.shadowColor = 'rgba(0,0,0,0.7)';
            ctx.lineWidth = 14;
            ctx.strokeStyle = '#ffeecc'; // æè¾¹å›ºå®š
            ctx.strokeText(keyTexts[soundKey].pinyin, 1024, 1260);
            // ===== æ‹¼éŸ³é¢œè‰² ===== ä»é…ç½®è¯»å– =====
            ctx.fillStyle = BUTTON_COLOR_CONFIG.textPinyinColor;
            ctx.shadowColor = 'rgba(204,153,0,0.9)';
            ctx.fillText(keyTexts[soundKey].pinyin, 1024, 1260);

            const texture = new THREE.CanvasTexture(canvas);
            texture.anisotropy = 16;
            const material = new THREE.MeshBasicMaterial({
                map: texture,
                transparent: true,
                depthWrite: false,
                depthTest: false,
                side: THREE.DoubleSide
            });
            // æ–‡å­—å°ºå¯¸å— textSize æ§åˆ¶
            const plane = new THREE.Mesh(new THREE.PlaneGeometry(ROUNDED_CONFIG.textSize * 0.95, ROUNDED_CONFIG.textSize * 1.0), material);
            plane.position.y = 0.23;
            plane.rotation.x = -Math.PI / 2;
            plane.scale.set(1, 1, 1);
            key.add(plane);
        }

        // ---------- æ¨¡å‹çƒ­æ›´æ–° ----------
        function updateModel(immediate = false) {
            if (updateTimeout) clearTimeout(updateTimeout);
            if (immediate) {
                createBase();
                createKeys();
                return;
            }
            updateTimeout = setTimeout(() => {
                createBase();
                createKeys();
                updateTimeout = null;
            }, 50);
        }

        // ---------- ğŸ® æ§åˆ¶é¢æ¿ç»‘å®šï¼ˆå«æ–°å¢æ–‡å­—é¢œè‰²ï¼‰----------
        function setupConfigPanel() {
            const panel = document.getElementById('config-panel');
            const toggleBtn = document.getElementById('toggle-config');
            const closeBtn = document.getElementById('closePanel');
            
            toggleBtn.onclick = () => { panel.style.display = panel.style.display === 'none' ? 'block' : 'none'; };
            closeBtn.onclick = () => panel.style.display = 'none';
            document.addEventListener('click', (e) => {
                if (panel.style.display === 'block' && !panel.contains(e.target) && e.target !== toggleBtn) 
                    panel.style.display = 'none';
            });

            // ---------- UI åŒæ­¥å‡½æ•°ï¼ˆå«æ–°å¢æ–‡å­—é¢œè‰²é¢„è§ˆï¼‰----------
            function syncUI() {
                // åœ†è§’
                document.getElementById('keyRadiusSlider').value = ROUNDED_CONFIG.keyRadius;
                document.getElementById('keyRadiusValue').textContent = ROUNDED_CONFIG.keyRadius.toFixed(2);
                document.getElementById('baseRadiusSlider').value = ROUNDED_CONFIG.baseRadius;
                document.getElementById('baseRadiusValue').textContent = ROUNDED_CONFIG.baseRadius.toFixed(2);
                document.getElementById('grooveRadiusSlider').value = ROUNDED_CONFIG.grooveRadius;
                document.getElementById('grooveRadiusValue').textContent = ROUNDED_CONFIG.grooveRadius.toFixed(2);
                document.getElementById('textSizeSlider').value = ROUNDED_CONFIG.textSize;
                document.getElementById('textSizeValue').textContent = ROUNDED_CONFIG.textSize.toFixed(1);

                // é˜´å½±
                document.getElementById('shadowIntensitySlider').value = SHADOW_CONFIG.intensity;
                document.getElementById('shadowIntensityValue').textContent = SHADOW_CONFIG.intensity.toFixed(1);
                document.getElementById('shadowSoftnessSlider').value = SHADOW_CONFIG.softness;
                document.getElementById('shadowSoftnessValue').textContent = SHADOW_CONFIG.softness.toFixed(1);
                document.getElementById('shadowColorPicker').value = SHADOW_CONFIG.color;
                document.getElementById('shadowColorValue').textContent = SHADOW_CONFIG.color;
                document.getElementById('shadowColorPreview').style.backgroundColor = SHADOW_CONFIG.color;

                // èƒŒæ™¯
                document.getElementById('bgColor1Picker').value = BACKGROUND_CONFIG.color1;
                document.getElementById('bgColor1Value').textContent = BACKGROUND_CONFIG.color1;
                document.getElementById('bgColor1Preview').style.backgroundColor = BACKGROUND_CONFIG.color1;
                document.getElementById('bgColor2Picker').value = BACKGROUND_CONFIG.color2;
                document.getElementById('bgColor2Value').textContent = BACKGROUND_CONFIG.color2;
                document.getElementById('bgColor2Preview').style.backgroundColor = BACKGROUND_CONFIG.color2;

                // æ¨¡æ¿è‰²
                document.getElementById('baseColorPicker').value = TEMPLATE_COLOR_CONFIG.baseColor;
                document.getElementById('baseColorValue').textContent = TEMPLATE_COLOR_CONFIG.baseColor;
                document.getElementById('baseColorPreview').style.backgroundColor = TEMPLATE_COLOR_CONFIG.baseColor;
                document.getElementById('grooveColorPicker').value = TEMPLATE_COLOR_CONFIG.grooveColor;
                document.getElementById('grooveColorValue').textContent = TEMPLATE_COLOR_CONFIG.grooveColor;
                document.getElementById('grooveColorPreview').style.backgroundColor = TEMPLATE_COLOR_CONFIG.grooveColor;

                // æŒ‰é’®é‡‰è‰²
                document.getElementById('keyYellowPicker').value = BUTTON_COLOR_CONFIG.keyYellow;
                document.getElementById('keyYellowValue').textContent = BUTTON_COLOR_CONFIG.keyYellow;
                document.getElementById('keyYellowPreview').style.backgroundColor = BUTTON_COLOR_CONFIG.keyYellow;
                document.getElementById('keyWhitePicker').value = BUTTON_COLOR_CONFIG.keyWhite;
                document.getElementById('keyWhiteValue').textContent = BUTTON_COLOR_CONFIG.keyWhite;
                document.getElementById('keyWhitePreview').style.backgroundColor = BUTTON_COLOR_CONFIG.keyWhite;

                // ğŸ†• æ–‡å­—é¢œè‰²
                document.getElementById('textColorYellowPicker').value = BUTTON_COLOR_CONFIG.textColorOnYellow;
                document.getElementById('textColorYellowValue').textContent = BUTTON_COLOR_CONFIG.textColorOnYellow;
                document.getElementById('textColorYellowPreview').style.backgroundColor = BUTTON_COLOR_CONFIG.textColorOnYellow;
                document.getElementById('textColorWhitePicker').value = BUTTON_COLOR_CONFIG.textColorOnWhite;
                document.getElementById('textColorWhiteValue').textContent = BUTTON_COLOR_CONFIG.textColorOnWhite;
                document.getElementById('textColorWhitePreview').style.backgroundColor = BUTTON_COLOR_CONFIG.textColorOnWhite;
                document.getElementById('textPinyinColorPicker').value = BUTTON_COLOR_CONFIG.textPinyinColor;
                document.getElementById('textPinyinColorValue').textContent = BUTTON_COLOR_CONFIG.textPinyinColor;
                document.getElementById('textPinyinColorPreview').style.backgroundColor = BUTTON_COLOR_CONFIG.textPinyinColor;

                // å…‰ç…§
                document.getElementById('globalBrightnessSlider').value = LIGHT_CONFIG.globalBrightness;
                document.getElementById('globalBrightnessValue').textContent = LIGHT_CONFIG.globalBrightness.toFixed(1);
                document.getElementById('ambientLightSlider').value = LIGHT_CONFIG.ambientLightIntensity;
                document.getElementById('ambientLightValue').textContent = LIGHT_CONFIG.ambientLightIntensity.toFixed(1);
                document.getElementById('mainLightSlider').value = LIGHT_CONFIG.mainLightIntensity;
                document.getElementById('mainLightValue').textContent = LIGHT_CONFIG.mainLightIntensity.toFixed(1);
                document.getElementById('fillLightSlider').value = LIGHT_CONFIG.fillLightIntensity;
                document.getElementById('fillLightValue').textContent = LIGHT_CONFIG.fillLightIntensity.toFixed(1);
                document.getElementById('backLightSlider').value = LIGHT_CONFIG.backLightIntensity;
                document.getElementById('backLightValue').textContent = LIGHT_CONFIG.backLightIntensity.toFixed(1);
            }
            syncUI();

            // ---------- åœ†è§’äº‹ä»¶ ----------
            document.getElementById('keyRadiusSlider').oninput = function() { 
                ROUNDED_CONFIG.keyRadius = +this.value; 
                document.getElementById('keyRadiusValue').textContent = this.value; 
                updateModel(); 
            };
            document.getElementById('baseRadiusSlider').oninput = function() { 
                ROUNDED_CONFIG.baseRadius = +this.value; 
                document.getElementById('baseRadiusValue').textContent = this.value; 
                updateModel(); 
            };
            document.getElementById('grooveRadiusSlider').oninput = function() { 
                ROUNDED_CONFIG.grooveRadius = +this.value; 
                document.getElementById('grooveRadiusValue').textContent = this.value; 
                updateModel(); 
            };
            document.getElementById('textSizeSlider').oninput = function() { 
                ROUNDED_CONFIG.textSize = +this.value; 
                document.getElementById('textSizeValue').textContent = this.value; 
                updateModel(); 
            };

            // ---------- é˜´å½±äº‹ä»¶ ----------
            document.getElementById('shadowIntensitySlider').oninput = function() { 
                SHADOW_CONFIG.intensity = +this.value; 
                document.getElementById('shadowIntensityValue').textContent = this.value; 
                keyShadows.forEach(s => s.material.opacity = SHADOW_CONFIG.intensity * 0.8); 
            };
            document.getElementById('shadowSoftnessSlider').oninput = function() { 
                SHADOW_CONFIG.softness = +this.value; 
                document.getElementById('shadowSoftnessValue').textContent = this.value; 
                scene.traverse(obj => { if (obj.isDirectionalLight && obj.shadow) obj.shadow.radius = SHADOW_CONFIG.softness * 3; }); 
            };
            document.getElementById('shadowColorPicker').oninput = function() { 
                SHADOW_CONFIG.color = this.value; 
                document.getElementById('shadowColorValue').textContent = this.value; 
                document.getElementById('shadowColorPreview').style.backgroundColor = this.value; 
                const nc = new THREE.Color(this.value); 
                keyShadows.forEach(s => s.material.color = nc); 
            };

            // ---------- èƒŒæ™¯äº‹ä»¶ ----------
            document.getElementById('bgColor1Picker').oninput = function() { 
                BACKGROUND_CONFIG.color1 = this.value; 
                document.getElementById('bgColor1Value').textContent = this.value; 
                document.getElementById('bgColor1Preview').style.backgroundColor = this.value; 
                updateBackground(); 
            };
            document.getElementById('bgColor2Picker').oninput = function() { 
                BACKGROUND_CONFIG.color2 = this.value; 
                document.getElementById('bgColor2Value').textContent = this.value; 
                document.getElementById('bgColor2Preview').style.backgroundColor = this.value; 
                updateBackground(); 
            };

            // ---------- æ¨¡æ¿è‰²äº‹ä»¶ ----------
            document.getElementById('baseColorPicker').oninput = function() { 
                TEMPLATE_COLOR_CONFIG.baseColor = this.value; 
                document.getElementById('baseColorValue').textContent = this.value; 
                document.getElementById('baseColorPreview').style.backgroundColor = this.value; 
                updateTemplateColors(); 
            };
            document.getElementById('grooveColorPicker').oninput = function() { 
                TEMPLATE_COLOR_CONFIG.grooveColor = this.value; 
                document.getElementById('grooveColorValue').textContent = this.value; 
                document.getElementById('grooveColorPreview').style.backgroundColor = this.value; 
                updateTemplateColors(); 
            };

            // ---------- æŒ‰é’®é‡‰è‰²äº‹ä»¶ ----------
            document.getElementById('keyYellowPicker').oninput = function() { 
                BUTTON_COLOR_CONFIG.keyYellow = this.value; 
                document.getElementById('keyYellowValue').textContent = this.value; 
                document.getElementById('keyYellowPreview').style.backgroundColor = this.value; 
                updateButtonColors(); 
            };
            document.getElementById('keyWhitePicker').oninput = function() { 
                BUTTON_COLOR_CONFIG.keyWhite = this.value; 
                document.getElementById('keyWhiteValue').textContent = this.value; 
                document.getElementById('keyWhitePreview').style.backgroundColor = this.value; 
                updateButtonColors(); 
            };

            // ========== ğŸ†• æ–‡å­—é¢œè‰²äº‹ä»¶ ==========
            document.getElementById('textColorYellowPicker').oninput = function() { 
                BUTTON_COLOR_CONFIG.textColorOnYellow = this.value; 
                document.getElementById('textColorYellowValue').textContent = this.value; 
                document.getElementById('textColorYellowPreview').style.backgroundColor = this.value; 
                updateModel(); // é‡å»ºæ–‡å­—çº¹ç†
            };
            document.getElementById('textColorWhitePicker').oninput = function() { 
                BUTTON_COLOR_CONFIG.textColorOnWhite = this.value; 
                document.getElementById('textColorWhiteValue').textContent = this.value; 
                document.getElementById('textColorWhitePreview').style.backgroundColor = this.value; 
                updateModel(); 
            };
            document.getElementById('textPinyinColorPicker').oninput = function() { 
                BUTTON_COLOR_CONFIG.textPinyinColor = this.value; 
                document.getElementById('textPinyinColorValue').textContent = this.value; 
                document.getElementById('textPinyinColorPreview').style.backgroundColor = this.value; 
                updateModel(); 
            };

            // ---------- å…‰ç…§äº‹ä»¶ ----------
            document.getElementById('globalBrightnessSlider').oninput = function() { 
                LIGHT_CONFIG.globalBrightness = +this.value; 
                document.getElementById('globalBrightnessValue').textContent = this.value; 
                updateLightIntensity(); 
            };
            document.getElementById('ambientLightSlider').oninput = function() { 
                LIGHT_CONFIG.ambientLightIntensity = +this.value; 
                document.getElementById('ambientLightValue').textContent = this.value; 
                updateLightIntensity(); 
            };
            document.getElementById('mainLightSlider').oninput = function() { 
                LIGHT_CONFIG.mainLightIntensity = +this.value; 
                document.getElementById('mainLightValue').textContent = this.value; 
                updateLightIntensity(); 
            };
            document.getElementById('fillLightSlider').oninput = function() { 
                LIGHT_CONFIG.fillLightIntensity = +this.value; 
                document.getElementById('fillLightValue').textContent = this.value; 
                updateLightIntensity(); 
            };
            document.getElementById('backLightSlider').oninput = function() { 
                LIGHT_CONFIG.backLightIntensity = +this.value; 
                document.getElementById('backLightValue').textContent = this.value; 
                updateLightIntensity(); 
            };

            // ---------- èƒŒæ™¯é¢„è®¾ ----------
            document.querySelectorAll('.color-preset-btn').forEach(btn => {
                btn.onclick = function() {
                    BACKGROUND_CONFIG.color1 = this.dataset.bg1;
                    BACKGROUND_CONFIG.color2 = this.dataset.bg2;
                    document.getElementById('bgColor1Picker').value = this.dataset.bg1;
                    document.getElementById('bgColor1Value').textContent = this.dataset.bg1;
                    document.getElementById('bgColor1Preview').style.backgroundColor = this.dataset.bg1;
                    document.getElementById('bgColor2Picker').value = this.dataset.bg2;
                    document.getElementById('bgColor2Value').textContent = this.dataset.bg2;
                    document.getElementById('bgColor2Preview').style.backgroundColor = this.dataset.bg2;
                    updateBackground();
                };
            });

            // ---------- åº”ç”¨ä¸é‡ç½® ----------
            document.getElementById('applyChanges').onclick = function() {
                updateModel(true);
                panel.style.display = 'none';
            };
            document.getElementById('resetDefaults').onclick = function() {
                ROUNDED_CONFIG = { ...DEFAULT_CONFIG.ROUNDED_CONFIG };
                SHADOW_CONFIG = { ...DEFAULT_CONFIG.SHADOW_CONFIG };
                BACKGROUND_CONFIG = { ...DEFAULT_CONFIG.BACKGROUND_CONFIG };
                TEMPLATE_COLOR_CONFIG = { ...DEFAULT_CONFIG.TEMPLATE_COLOR_CONFIG };
                BUTTON_COLOR_CONFIG = { ...DEFAULT_CONFIG.BUTTON_COLOR_CONFIG };
                LIGHT_CONFIG = { ...DEFAULT_CONFIG.LIGHT_CONFIG };
                syncUI();
                updateModel(true);
                updateBackground();
                updateTemplateColors();
                updateButtonColors();
                updateLightIntensity();
                const nc = new THREE.Color(SHADOW_CONFIG.color);
                keyShadows.forEach(s => s.material.color = nc);
                this.textContent = 'â™»ï¸ å·²å¤ä½';
                setTimeout(() => this.textContent = 'é‡ç½®è‡³å®', 1000);
            };
        }

        // ---------- äº¤äº’äº‹ä»¶ ----------
        function bindEvents() {
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();

            window.addEventListener('click', (e) => {
                const panel = document.getElementById('config-panel');
                if (panel.style.display === 'block' && (panel.contains(e.target) || e.target.id === 'toggle-config')) return;

                mouse.x = (e.clientX / innerWidth) * 2 - 1;
                mouse.y = -(e.clientY / innerHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(keys);
                
                if (intersects.length) {
                    const key = intersects[0].object;
                    if (key.userData.isPressed) return;
                    key.userData.isPressed = true;

                    const shadow = keyShadows[key.userData.shadowIndex];
                    
                    const pressAnimation = () => {
                        const dyKey = key.userData.originalY - 0.1 - key.position.y;
                        const dyShadow = shadow.userData.originalY - 0.05 - shadow.position.y;
                        if (Math.abs(dyKey) > 0.003) {
                            key.position.y += dyKey * 0.35;
                            shadow.position.y += dyShadow * 0.35;
                            shadow.scale.set(0.92, 1, 0.92);
                            requestAnimationFrame(pressAnimation);
                        } else {
                            setTimeout(releaseAnimation, 120);
                        }
                    };

                    const releaseAnimation = () => {
                        const dyKey = key.userData.originalY - key.position.y;
                        const dyShadow = shadow.userData.originalY - shadow.position.y;
                        if (Math.abs(dyKey) > 0.003) {
                            key.position.y += dyKey * 0.25;
                            shadow.position.y += dyShadow * 0.25;
                            requestAnimationFrame(releaseAnimation);
                        } else {
                            key.position.y = key.userData.originalY;
                            shadow.position.y = shadow.userData.originalY;
                            shadow.scale.set(1, 1, 1);
                            key.userData.isPressed = false;
                        }
                    };

                    pressAnimation();
                    try { new Audio(sounds[key.userData.sound]).play(); } catch (e) {}
                }
            });

            window.addEventListener('resize', () => {
                camera.aspect = innerWidth / innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(innerWidth, innerHeight);
            });
        }

        // ---------- åŠ¨ç”»å¾ªç¯ ----------
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            if (particles) {
                particles.rotation.y += 0.00015;
                particles.rotation.x += 0.00005;
            }
            renderer.render(scene, camera);
        }

        window.addEventListener('load', init);
        window.animate = animate;
        animate();
    </script>
</body>
</html>